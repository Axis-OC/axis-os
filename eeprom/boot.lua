local a,b=component,computer;local c,d,e,f,g;for h,i in a.list()do local j=a.proxy(h)if i=="gpu"and not c then c=j elseif i=="screen"and not d then d=h elseif i=="eeprom"and not e then e=j elseif i=="data"and not f then f=j elseif i=="filesystem"and not g then if j.exists("/kernel.lua")then g=j end end end;if not c or not d then b.beep(1000,.2)error("NO GPU")end;c.bind(d)local k,l=c.maxResolution()c.setResolution(k,l)c.setBackground(0)c.setForeground(0xFFFFFF)c.fill(1,1,k,l," ")local m,n,o=1,math.floor,string.format;local function p(q,r)if r then c.setForeground(r)end;c.set(2,m,tostring(q))m=m+1 end;local function s(t)c.setForeground(0xFF0000)c.set(2,l-2,"SECURE BOOT FAILURE")c.setForeground(0xFF5555)c.set(2,l-1,tostring(t):sub(1,k-4))b.beep(200,1)while true do b.pullSignal(math.huge)end end;local function u(q)local i={}for v=1,#q do i[v]=o("%02x",q:byte(v))end;return table.concat(i)end;local function w(x)local y=g.open(x,"r")if not y then return end;local i={}while true do local q=g.read(y,4096)if not q then break end;i[#i+1]=q end;g.close(y)return table.concat(i)end;local function z(q,A,B)local t=q:sub(A,A+B-1)local C=t:find("\0",1,true)return C and t:sub(1,C-1)or t end;if not g then s("No system disk")end;p("AxisOS SB",0x00BCD4)p(string.rep("=",36),0x333333)p("")local D={v=false,b="",k=""}if f then p("[1/4]...",0xAAAAAA)local E,F="",""if e then local G=e.getData()if G and#G>=144 and G:sub(1,4)=="AXCF"then E=z(G,17,64)F=z(G,81,64)end end;if#E==0 then local H=w("/boot/efi/machine.bind")if H then H=H:gsub("%s+","")if#H>0 then E=H end end end;if#F==0 then local I=w("/boot/efi/kernel.hash")if I then I=I:gsub("%s+","")if#I>0 then F=I end end end;p("  stored bind: "..(#E>0 and E:sub(1,16).."..."or"(none)"),#E>0 and 0x55FF55 or 0xFFAA00)p("  stored hash: "..(#F>0 and F:sub(1,16).."..."or"(none)"),#F>0 and 0x55FF55 or 0xFFAA00)p("[2/4]",0xAAAAAA)D.b=u(f.sha256((f.address or"")..(e and e.address or"")..(g.address or"")))p("  "..D.b:sub(1,20).."...",0x55FF55)p("[3/4] Kernel integrity...",0xAAAAAA)local J=w("/kernel.lua")if not J or#J<100 then s("Kernel corrupt")end;D.k=u(f.sha256(J))p("  "..D.k:sub(1,20).."...",0x55FF55)p("[4/4]",0xAAAAAA)local K=#E>0 or#F>0;local L=#E==0 or D.b==E;local M=#F==0 or D.k==F;if K and L and M then D.v=true;p("pass",0x55FF55)elseif not K then p("  NO ATTESTATION DATA",0xFFAA00)p("  run: secureboot hash / bind",0xFFAA00)else if not L then p("  BIND MISMATCH!",0xFF5555)p("  exp:"..E:sub(1,20),0xFF5555)p("  got:"..D.b:sub(1,20),0xFF5555)end;if not M then p("  HASH MISMATCH!",0xFF5555)p("  exp:"..F:sub(1,20),0xFF5555)p("  got:"..D.k:sub(1,20),0xFF5555)end end;local N=w("/boot/manifest.sig")p("  Manifest: "..(N and"PRESENT"or"(none)"),N and 0x55FF55 or 0xFFAA00)else p("ndc;skip",0xFFAA00)if not w("/kernel.lua")then s("No kernel")end end;p("")c.setForeground(0xC0C0C0)for O,P in ipairs({"AxisOS"})do c.set(n((k-#P)/2),m,P)m=m+1 end;p("")p("AxisOS v0.5",0xFFFFFF)c.setForeground(0xAAAAAA)c.set(n((k-24)/2),l-2,"Press DEL for BIOS Setup")c.setForeground(D.v and 0x55FF55 or 0xFFAA00)c.set(2,l,"SB: "..(D.v and"VERIFIED"or"UNVERIFIED"))local Q=b.uptime()+3;while b.uptime()<Q do local R,O,O,S=b.pullSignal(.1)if R=="key_down"then if S==211 then b.beep(1000,.1)local T=w("/boot/setup.lua")if T then local U=load(T,"@setup","t",{component=a,computer=b,unicode=unicode,string=string,math=math,table=table,pairs=pairs,ipairs=ipairs,type=type,tostring=tostring,tonumber=tonumber,pcall=pcall,error=error,load=load,setmetatable=setmetatable,select=select,next=next})if U then pcall(U)end end;break elseif S==28 then break end end end;c.fill(1,1,k,l," ")c.set(1,1,"Booting...")b.beep(900,.2)local V=w("/kernel.lua")if not V or#V<100 then s("Kernel missing")end;if V:sub(1,3)=="\239\187\191"then V=V:sub(4)end;local W={lvl="Info",safe="Disabled",wait="0",init="/bin/init.lua"}do local X=w("/boot/loader.cfg")if X then local U=load(X,"loader.cfg","t",{})if U then local Y,Z=pcall(U)if Y and Z and Z.entries then for O,_ in ipairs(Z.entries)do if _.id==(Z.default or"axis")then if _.init then W.init=_.init end;if _.params then if _.params.loglevel then W.lvl=_.params.loglevel end;if _.params.safemode then W.safe="Enabled"end end;break end end end end end end;local a0={raw_component=a,raw_computer=b,boot_fs_address=g.address,boot_args=W}if D.v then a0.boot_security={machine_binding=D.b,kernel_hash=D.k,data_card_addr=f.address,verified=true}end;setmetatable(a0,{__index=_G})local U,a1=load(V,"=kernel","t",a0)if not U then s("PARSE: "..tostring(a1))end;local Y,a2=xpcall(U,debug.traceback)if not Y then s("PANIC: "..tostring(a2))end