local a,b=component,computer;local c,d,e,f,g;for h,i in a.list()do local j=a.proxy(h)if i=="gpu"and not c then c=j elseif i=="screen"and not d then d=h elseif i=="eeprom"and not e then e=j elseif i=="data"and not f then f=j elseif i=="filesystem"and not g then if j.exists("/kernel.lua")then g=j end end end;if not(c and d)then b.beep(1000,.2)error("NO GPU")end;c.bind(d)local k,l=c.maxResolution()c.setResolution(k,l)c.setBackground(0)c.setForeground(0xFFFFFF)c.fill(1,1,k,l," ")local m=1;local function n(i,o)if o then c.setForeground(o)end;c.set(2,m,i)m=m+1 end;local function p(q)c.setForeground(0xFF0000)c.set(2,l-2,"BOOT BLOCKED")c.setForeground(0xFF5555)c.set(2,l-1,tostring(q):sub(1,k-4))b.beep(200,1)while true do b.pullSignal(math.huge)end end;local function r(s)return s:gsub(".",function(t)return("%02x"):format(t:byte())end)end;local function u(v)local w=g.open(v,"r")if not w then return end;local i={}while true do local d=g.read(w,4096)if not d then break end;i[#i+1]=d end;g.close(w)return table.concat(i)end;local function x(d,y,z)local q=d:sub(y,y+z-1)local s=q:find("\0",1,true)return s and q:sub(1,s-1)or q end;if not g then p("No system disk")end;n("AxisOS SecureBoot",0x00BCD4)n("")local A,B,C=false,"",""if f then local D,E="",""if e then local F=e.getData()if F and#F>=144 and F:sub(1,4)=="AXCF"then D=x(F,17,64)E=x(F,81,64)end end;if#D==0 then local j=u("/boot/efi/machine.bind")if j then j=j:gsub("%s+","")if#j>0 then D=j end end end;if#E==0 then local j=u("/boot/efi/kernel.hash")if j then j=j:gsub("%s+","")if#j>0 then E=j end end end;n("Binding...",0xAAAAAA)B=r(f.sha256((f.address or"")..(e and e.address or"")..(g.address or"")))local G=u("/kernel.lua")if not G or#G<100 then p("Kernel corrupt")end;n("Hashing...",0xAAAAAA)C=r(f.sha256(G))local H=#D>0 or#E>0;local I=#D==0 or B==D;local J=#E==0 or C==E;if H and I and J then A=true;n("VERIFIED",0x55FF55)elseif not H then n("NO ATTESTATION",0xFFAA00)else if not I then n("BIND MISMATCH",0xFF5555)end;if not J then n("HASH MISMATCH",0xFF5555)end;p("Verification failed")end else local K=false;if e then local F=e.getData()if F and#F>=16 and F:sub(1,4)=="AXCF"then for L=17,144 do if(F:byte(L)or 0)~=0 then K=true;break end end end end;if K then p("Data card required")end;n("No data card",0xFFAA00)if not u("/kernel.lua")then p("No kernel")end end;n("")c.setForeground(0xAAAAAA)c.set(math.floor((k-24)/2),l-2,"Press DEL for BIOS Setup")c.setForeground(A and 0x55FF55 or 0xFFAA00)c.set(2,l,"SB:"..(A and"OK"or"??"))local M=b.uptime()+3;while b.uptime()<M do local N,O,O,P=b.pullSignal(.1)if N=="key_down"then if P==211 then b.beep(1000,.1)local Q=u("/boot/setup.lua")if Q then local R=load(Q,"@setup","t",setmetatable({component=a,computer=b},{__index=_G}))if R then pcall(R)end end;break elseif P==28 then break end end end;c.fill(1,1,k,l," ")c.set(1,1,"Booting...")b.beep(900,.2)local G=u("/kernel.lua")if not G or#G<100 then p("Kernel missing")end;if G:sub(1,3)=="\239\187\191"then G=G:sub(4)end;local S={lvl="Info",safe="Disabled",wait="0",init="/bin/init.lua"}pcall(function()local T=load(u("/boot/loader.cfg"),"l","t",{})()for O,U in ipairs(T.entries)do if U.id==(T.default or"axis")then S.init=U.init or S.init;if U.params then S.lvl=U.params.loglevel or S.lvl;if U.params.safemode then S.safe="Enabled"end end;break end end end)local V={raw_component=a,raw_computer=b,boot_fs_address=g.address,boot_args=S}if A then V.boot_security={machine_binding=B,kernel_hash=C,data_card_addr=f.address,verified=true}end;setmetatable(V,{__index=_G})local R,W=load(G,"=kernel","t",V)if not R then p("PARSE:"..tostring(W))end;local X,Y=xpcall(R,debug.traceback)if not X then p("PANIC:"..tostring(Y))end